import pickle
import argparse
import os

def inspect_pickle_file(filepath):
    """
    Loads a pickle file and prints a summary of its contents.
    """
    if not os.path.exists(filepath):
        print(f"❌ Error: File not found at '{filepath}'")
        return

    print(f"--- Inspecting: {filepath} ---\n")

    try:
        with open(filepath, 'rb') as f:
            data = pickle.load(f)

        # --- Print General Information ---
        data_type = type(data)
        print(f"✅ Successfully loaded pickle file.")
        print(f"   - Top-level data type: {data_type.__name__}")

        # --- Detailed Inspection based on Type ---
        if isinstance(data, dict):
            print(f"   - Number of keys: {len(data)}")
            print("\n--- Dictionary Keys and Value Types ---")
            for key, value in data.items():
                value_type = type(value)
                value_info = f"Type: {value_type.__name__}"
                if hasattr(value, 'shape'):
                    value_info += f", Shape: {value.shape}"
                if hasattr(value, '__len__'):
                    value_info += f", Length: {len(value)}"
                print(f"  - Key: '{key}' -> {value_info}")

        elif isinstance(data, list):
            print(f"   - Number of items: {len(data)}")
            if len(data) > 0:
                first_item = data[0]
                print(f"   - Type of first item: {type(first_item).__name__}")

                if isinstance(first_item, dict):
                    print("\n--- Keys in the first dictionary item ---")
                    for key, value in first_item.items():
                        value_type = type(value)
                        value_info = f"Type: {value_type.__name__}"
                        if hasattr(value, 'shape'):
                            value_info += f", Shape: {value.shape}"
                        print(f"  - Key: '{key}' -> {value_info}")
                    print("(Assuming all list items have a similar structure)")

        elif hasattr(data, 'shape'):
             print(f"   - Shape of the array: {data.shape}")

        print("\n--- Inspection Complete ---")

    except (pickle.UnpicklingError, EOFError) as e:
        print(f"❌ Error: Failed to unpickle the file. It might be corrupted or not a valid pickle file.")
        print(f"   Details: {e}")
    except Exception as e:
        print(f"An unexpected error occurred: {e}")


if __name__ == '__main__':
    # --- Command-Line Argument Parser ---
    parser = argparse.ArgumentParser(
        description="Inspect the contents of a .pkl file generated by mmaction2's test command.",
        formatter_class=argparse.RawTextHelpFormatter
    )
    parser.add_argument(
        'filepath',
        type=str,
        help="Path to the .pkl file to inspect.\nExample: python test_results/inspect_pickle.py test_results/816_rtmpose_both_2D_joint_joint.pkl"
    )

    args = parser.parse_args()
    inspect_pickle_file(args.filepath)
